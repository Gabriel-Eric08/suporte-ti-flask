<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECRETARIA DA MULHER - Sistema de Chamados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
    <style>
        :root {
            --bs-pink-primary: #d81b60;
            --bs-pink-hover: #ff69b4;
            --bs-bg-light: #f9f9f9;
            --bs-bg-white: #ffffff;
            --bs-text-muted: #6c757d;
        }

        body { background-color: var(--bs-bg-light); }
        .sidebar { height: 100vh; background-color: var(--bs-bg-white); padding-top: 20px; box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1); border-right: 3px solid var(--bs-pink-primary); }
        .sidebar .sidebar-header { color: var(--bs-pink-primary); font-weight: bold; text-transform: uppercase; }
        .sidebar .nav-link { color: var(--bs-pink-primary); padding: 15px 20px; font-weight: 500; border-left: 5px solid transparent; transition: all 0.3s; }
        .sidebar .nav-link:hover { background-color: #fff0f5; color: var(--bs-pink-hover); border-left: 5px solid var(--bs-pink-hover); }
        .sidebar .nav-link.active { background-color: #fff0f5; color: var(--bs-pink-primary); border-left: 5px solid var(--bs-pink-primary); font-weight: bold; }
        .main-content { padding: 30px; min-height: 100vh; }
        .hero-title { color: var(--bs-pink-primary); font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; }
        .hero-subtitle { color: var(--bs-text-muted); font-style: italic; }
        .btn-primary { background-color: var(--bs-pink-primary) !important; border-color: var(--bs-pink-primary) !important; }
        .btn-primary:hover { background-color: var(--bs-pink-hover) !important; border-color: var(--bs-pink-hover) !important; }
        /* Estilo para campo readonly */
        .form-control[readonly] {
            background-color: var(--bs-bg-light); 
            opacity: 0.8;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="position-sticky">
                    
                    <div class="sidebar-header text-center mb-4 pb-3 border-bottom">
                        <i class="bi bi-person-workspace me-2"></i> Suporte TI
                    </div>

                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="#">
                                <i class="bi bi-headset me-2"></i> Abrir Chamado
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-chat-dots me-2"></i> Deixar Feedback
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('Admin_chamados.admin_page') }}">
                                <i class="bi bi-shield-lock me-2"></i> Página de Administrador
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="{{ url_for('User.user_page') }}"> <i class="bi bi-person-circle me-2"></i> Minhas Informações
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('Cliente.cliente_page') }}">
                                <i class="bi bi-shield-lock me-2"></i> Meus chamados
                            </a>
                        </li>
                    </ul>

                    <hr class="mx-3 mt-4 mb-2 text-muted">

                    <ul class="nav flex-column mb-0">
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-box-arrow-right me-2"></i> Sair
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
                
                <div class="text-center pt-5 pb-5 mb-5">
                    <h1 class="hero-title">SECRETARIA DA MULHER</h1>
                    <p class="hero-subtitle lead">Sistema de chamados para suporte de TI</p>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-10 col-xl-8">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white border-bottom border-3" style="border-color: var(--bs-pink-primary) !important;">
                                <h4 class="mb-0 text-center" style="color: var(--bs-pink-primary);">
                                    <i class="bi bi-ticket-perforated me-2"></i> Iniciar Novo Chamado
                                </h4>
                            </div>
                            <div class="card-body p-4">
                                <p class="text-center text-muted">
                                    Selecione o tipo de problema e descreva o ocorrido para que possamos te ajudar.
                                </p>
                                
                                <form id="formChamado">
                                    
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label for="nomeSolicitante" class="form-label">Nome Completo do Solicitante</label>
                                            <!-- Campo VISUAL (somente leitura) preenchido com o nome completo, mas o valor real enviado será o USERNAME do cookie -->
                                            <input type="text" class="form-control" id="nomeSolicitante" value="{{ nome }}" readonly required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="setorSolicitante" class="form-label">Setor / Unidade do Solicitante</label>
                                            <select class="form-select" id="setorSolicitante" required>
                                                <option value="" selected disabled>Selecione seu Setor</option>
                                                </select>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <label for="tipoProblema" class="form-label fw-bold" style="color: var(--bs-pink-primary);">Tipo de Problema <span class="text-danger">*</span></label>
                                        <select class="form-select form-select-lg" id="tipoProblema" aria-label="Selecione o Tipo de Problema" required>
                                            <option value="" selected disabled>Selecione um item da lista</option>
                                            <option value="1">1° PC não liga</option>
                                            <option value="2">2° Mouse ou teclado com defeito</option>
                                            <option value="3">3° Instalação de programa</option>
                                            <option value="4">4° Internet sem funcionar</option>
                                            <option value="5">5° Esqueceu senha de acesso (computador, Expresso ou SEI)</option>
                                            <option value="6">6° Criação de novo login (catracas, Expresso, SEI e computador)</option>
                                            <option value="7">7° Impressora sem funcionar</option>
                                            <option value="8">8° Outros</option>
                                        </select>
                                    </div>
                                    
                                    <div id="camposVariaveis">
                                        <p class="text-center text-muted p-4 bg-light rounded">
                                            * Por favor, selecione um tipo de problema acima para continuar.
                                        </p>
                                    </div>

                                    <div id="campoDescricaoGeral" class="mb-3 d-none">
                                        <label for="descricaoGeral" class="form-label">Descrição Detalhada do Problema / Informações Adicionais</label>
                                        <textarea class="form-control" id="descricaoGeral" rows="3" placeholder="Descreva o problema ou adicione detalhes que ajudem a equipe de TI (localização, programa, etc)."></textarea>
                                    </div>

                                    <div class="text-center mt-4">
                                        <button type="submit" class="btn btn-lg btn-primary">
                                            <i class="bi bi-send-fill me-2"></i> Enviar Chamado
                                        </button>
                                    </div>
                                </form>
                                </div>
                        </div>
                    </div>
                </div>
                
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tipoProblemaSelect = document.getElementById('tipoProblema');
            const setorSolicitanteSelect = document.getElementById('setorSolicitante'); 
            const nomeSolicitanteInput = document.getElementById('nomeSolicitante');
            const camposVariaveisDiv = document.getElementById('camposVariaveis');
            const campoDescricaoGeralDiv = document.getElementById('campoDescricaoGeral');
            const formChamado = document.getElementById('formChamado');

            // ====================================================================
            // 1. Dicionários de Mapeamento (Lookup Tables)
            // ====================================================================
            const setorMap = {
                'Enfrentamento': 1,
                'Comunicação': 2,
                'Orçamentário': 3, 
                'RH': 4,
                'Licitação': 5,
                'Contratos/Convênios': 6,
                'DPMM/GERAI/GFEG/GFESP': 7,
                'Gabinete Secretaria': 8,
                'Gabinete Executivo/Jurídico': 9,
                'Ouvidoria/Gerência Geral ADM': 10,
                'Protocolo': 11
            };          

            const plataformaMap = {
                'Computador': 1,
                'Expresso/SEI': 2
            };
            
            // --- FUNÇÃO DE POPULAR O SELECT DO SETOR ---
            function popularSetorSelect() {
                let setorOptions = '';
                for (const nome in setorMap) {
                    setorOptions += `<option value="${nome}">${nome}</option>`;
                }
                setorSolicitanteSelect.insertAdjacentHTML('beforeend', setorOptions);
            }

            // --- FUNÇÃO DE RENDERIZAR CAMPOS DINÂMICOS ---
            function renderCamposVariaveis(tipo) {
                camposVariaveisDiv.innerHTML = '';
                campoDescricaoGeralDiv.classList.add('d-none');
                
                // Renderizar a Descrição Geral se não for tipo 5 ou 6
                if (tipo && tipo !== '5' && tipo !== '6') {
                    campoDescricaoGeralDiv.classList.remove('d-none');
                }

                // ====================================================================
                // CASO 5: Esqueceu Senha
                // ====================================================================
                if (tipo === '5') {
                    campoDescricaoGeralDiv.classList.remove('d-none');

                    let plataformaOptions = '<option value="" selected disabled>Selecione a plataforma</option>';
                    for (const nome in plataformaMap) {
                        plataformaOptions += `<option value="${nome}">${nome}</option>`;
                    }

                    camposVariaveisDiv.innerHTML = `
                        <div class="alert alert-warning border-start border-3 border-warning" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> **Atenção:** Informe qual a **Plataforma** para o reset de senha.
                        </div>
                        <div class="mb-3">
                            <label for="plataformaInput" class="form-label">Plataforma</label>
                            <select class="form-select" id="plataformaInput" name="plataformaInput" required>
                                ${plataformaOptions}
                            </select>
                        </div>
                    `;
                } 
                
                // ====================================================================
                // CASO 6: Criação de Novo Login
                // ====================================================================
                else if (tipo === '6') {
                    campoDescricaoGeralDiv.classList.remove('d-none');
                    
                    camposVariaveisDiv.innerHTML = `
                        <div class="alert alert-info border-start border-3 border-info" role="alert">
                            <i class="bi bi-info-circle-fill me-2"></i> **Preencha com os dados do NOVO USUÁRIO**
                        </div>
                        <div class="mb-3">
                            <label for="cpfInput" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="cpfInput" name="cpfInput" required>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="cargoInput" class="form-label">Cargo</label>
                                <input type="text" class="form-control" id="cargoInput" name="cargoInput" placeholder="Ex: Analista de TI" required>
                            </div>
                            <div class="col-md-6">
                                <label for="unidadeSeiInput" class="form-label">Unidade/Setor que o usuário terá acesso no SEI</label>
                                <input type="text" class="form-control" id="unidadeSeiInput" name="unidadeSeiInput" placeholder="Ex: Secretaria da Mulher" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="acessosAdicionais" class="form-label">Acessos Adicionais (Catracas, Expresso, Computador, etc.)</label>
                            <textarea class="form-control" id="acessosAdicionais" name="acessosAdicionais" rows="2" placeholder="Ex: Precisa de acesso na catraca X e Y."></textarea>
                        </div>
                    `;
                } 
                
                // ====================================================================
                // OUTROS CASOS
                // ====================================================================
                else if (tipo === '') {
                        camposVariaveisDiv.innerHTML = `
                            <p class="text-center text-muted p-4 bg-light rounded">
                                * Por favor, selecione um tipo de problema acima para continuar.
                            </p>
                        `;
                }
            }

            // --- EXECUÇÃO INICIAL ---
            popularSetorSelect(); 
            renderCamposVariaveis(tipoProblemaSelect.value);

            // --- EVENT LISTENERS ---
            tipoProblemaSelect.addEventListener('change', function() {
                renderCamposVariaveis(this.value);
            });

            // ====================================================================
            // 2. FUNÇÃO DE SUBMISSÃO (Onde nome_completo E user são enviados)
            // ====================================================================

            formChamado.addEventListener('submit', async function(event) {
                event.preventDefault();

                const tipo = tipoProblemaSelect.value;
                const setorNome = setorSolicitanteSelect.value;

                // Validação de campos principais
                if (!tipo || !setorNome || setorNome === '') {
                    Swal.fire('Erro!', 'Por favor, preencha todos os campos obrigatórios e selecione o tipo de problema/setor.', 'error');
                    return;
                }

                const setorId = setorMap[setorNome];
                if (!setorId) {
                    Swal.fire('Erro de Setor!', 'O Setor selecionado não foi reconhecido. Verifique e tente novamente.', 'error');
                    return;
                }
                
                // --- Lógica para obter o valor do COOKIE 'username' ---
                const usernameCookie = document.cookie.split('; ').find(row => row.startsWith('username='));
                
                let userLogin;
                if(usernameCookie) {
                    // Valor do cookie (o login, ex: juliana.silva)
                    userLogin = usernameCookie.split('=')[1]; 
                } else {
                    // Fallback: se o cookie falhar, usa o nome completo que está no input readonly (MENOS IDEAL)
                    userLogin = nomeSolicitanteInput.value; 
                    console.warn("Cookie 'username' não encontrado. Enviando o valor do input 'nomeSolicitante' como login.");
                }
                // -----------------------------------------------------------

                // Monta o objeto base do JSON.
                const payload = {
                    // Ambos os campos recebem o valor do cookie ('juliana.silva')
                    nome_completo: userLogin, 
                    user: userLogin, 
                    setor_id: setorId,
                    tipo_id: parseInt(tipo),
                    // O campo aqui se chama 'desc', que é o que o PY espera
                    desc: document.getElementById('descricaoGeral').value || null, 
                    cpf: null,
                    plataforma_id: null,
                    cargo: null, 
                    unidade_sei: null 
                };

                // --- Campos Condicionais ---
                if (tipo === '5') {
                    const plataformaNome = document.getElementById('plataformaInput').value;
                    payload.plataforma_id = plataformaMap[plataformaNome] || null;
                    if (!payload.plataforma_id) { Swal.fire('Erro!', 'Selecione a plataforma para a recuperação de senha.', 'error'); return; }
                } else if (tipo === '6') {
                    const cargoTexto = document.getElementById('cargoInput').value.trim();
                    const unidadeTexto = document.getElementById('unidadeSeiInput').value.trim();
                    const acessos = document.getElementById('acessosAdicionais').value;
                    payload.cpf = document.getElementById('cpfInput').value.trim();
                    payload.cargo = cargoTexto; 
                    payload.unidade_sei = unidadeTexto; 
                    let descBase = payload.desc ? payload.desc + "\n" : "";
                    if (acessos.trim()) { payload.desc = descBase + "ACESSOS ADICIONAIS: " + acessos; }
                    if (!payload.cpf || !payload.cargo || !payload.unidade_sei) { Swal.fire('Erro!', 'Preencha todos os dados de novo login (CPF, Cargo e Unidade SEI).', 'error'); return; }
                }
                
                // Limpeza final do payload (remove chaves com valor null/vazio antes de enviar)
                Object.keys(payload).forEach(key => {
                    if (payload[key] === null || payload[key] === '') {
                        delete payload[key];
                    }
                });

                // ** LOG DE DEBUG (CONFIRMA O PAYLOAD ENVIADO) **
                console.log("PAYLOAD ENVIADO PARA O FLASK:", JSON.stringify(payload, null, 2));


                // --- Envio da Requisição ---
                const apiUrl = '/chamados/'; 

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        
                        let swalText = `Seu chamado foi registrado com sucesso! (ID: ${result.id})`;
                        
                        if (result.posicao_na_fila !== undefined) {
                            swalText += `<br><br>Você é o **${result.posicao_na_fila}º** na fila de atendimento.`
                        }
                        
                        Swal.fire({
                            title: 'Chamado Enviado!',
                            html: swalText,
                            icon: 'success',
                            confirmButtonColor: 'var(--bs-pink-primary)'
                        }).then(() => {
                            formChamado.reset(); 
                            renderCamposVariaveis(''); // Reseta a visualização
                        });
                        
                    } else {
                        Swal.fire('Erro!', result.message || 'Ocorreu um erro desconhecido ao enviar o chamado.', 'error');
                    }
                } catch (error) {
                    console.error('Erro na requisição:', error);
                    Swal.fire('Erro de Conexão!', 'Não foi possível conectar ao servidor. Tente novamente.', 'error');
                }
            });
        });
    </script>
</body>
</html>
