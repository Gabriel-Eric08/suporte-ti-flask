<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SECRETARIA DA MULHER - Meus Chamados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
  <style>
    /* Estilos CSS do layout anterior, mantidos */
    :root {
      --bs-pink-primary: #d81b60;
      --bs-pink-hover: #ff69b4;
      --bs-bg-light: #f9f9f9;
      --bs-bg-white: #ffffff;
      --bs-text-muted: #6c757d;
    }

    body { background-color: var(--bs-bg-light); }
    .sidebar { height: 100vh; background-color: var(--bs-bg-white); padding-top: 20px; box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1); border-right: 3px solid var(--bs-pink-primary); }
    .sidebar .sidebar-header { color: var(--bs-pink-primary); font-weight: bold; text-transform: uppercase; }
    .sidebar .nav-link { color: var(--bs-pink-primary); padding: 15px 20px; font-weight: 500; border-left: 5px solid transparent; transition: all 0.3s; }
    .sidebar .nav-link:hover { background-color: #fff0f5; color: var(--bs-pink-hover); border-left: 5px solid var(--bs-pink-hover); }
    /* CLASSE ACTIVE AJUSTADA */
    .sidebar .nav-link.active-meus-chamados { 
      background-color: #fff0f5; 
      color: var(--bs-pink-primary); 
      border-left: 5px solid var(--bs-pink-primary); 
      font-weight: bold; 
    }
    .main-content { padding: 30px; min-height: 100vh; }
    .hero-title { color: var(--bs-pink-primary); font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; }
    .hero-subtitle { color: var(--bs-text-muted); font-style: italic; }
    .btn-primary { background-color: var(--bs-pink-primary) !important; border-color: var(--bs-pink-primary) !important; }
    .btn-primary:hover { background-color: var(--bs-pink-hover) !important; border-color: var(--bs-pink-hover) !important; }
    
    .table-header-pink th { 
      background-color: var(--bs-pink-primary); 
      color: white; 
      font-weight: 600;
    }
  </style>
</head>
<body>

  <div class="container-fluid">
    <div class="row">
      
      <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar">
        <div class="position-sticky">
          
          <div class="sidebar-header text-center mb-4 pb-3 border-bottom">
            <i class="bi bi-person-workspace me-2"></i> Suporte TI
          </div>

          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('Home.home_page') }}">
                <i class="bi bi-headset me-2"></i> Abrir Chamado
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <i class="bi bi-chat-dots me-2"></i> Deixar Feedback
              </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#"> <i class="bi bi-person-circle me-2"></i> Minhas Informações
                </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('Admin_chamados.admin_page') }}">
                <i class="bi bi-shield-lock me-2"></i> Página de Administrador
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active-meus-chamados" aria-current="page" href="#">
                <i class="bi bi-card-checklist me-2"></i> Meus chamados
              </a>
            </li>
          </ul>

          <hr class="mx-3 mt-4 mb-2 text-muted">

          <ul class="nav flex-column mb-0">
            <li class="nav-item">
              <a class="nav-link" href="#">
                <i class="bi bi-box-arrow-right me-2"></i> Sair
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
        
        <div class="text-center pt-5 pb-5 mb-5">
          <h1 class="hero-title">Meus Chamados</h1>
          <p class="hero-subtitle lead">Visualização e acompanhamento dos seus chamados de suporte</p>
        </div>

        <div class="card shadow-sm border-0 mb-4">
          <div class="card-header bg-white border-bottom border-3" style="border-color: var(--bs-pink-primary) !important;">
            <h5 class="mb-0" style="color: var(--bs-pink-primary);">
              <i class="bi bi-funnel-fill me-2"></i> Filtros de Pesquisa
            </h5>
          </div>
          <div class="card-body">
            <form id="formFiltro" class="row g-3">
              <div class="col-md-4">
                <label for="dataInicial" class="form-label">Data Inicial</label>
                <input type="date" class="form-control" id="dataInicial" name="data_inicial" value="{{ request.args.get('data_inicial', '') }}">
              </div>
              <div class="col-md-4">
                <label for="dataFinal" class="form-label">Data Final</label>
                <input type="date" class="form-control" id="dataFinal" name="data_final" value="{{ request.args.get('data_final', '') }}">
              </div>
              
              <div class="col-md-4">
                <label for="statusFiltro" class="form-label">Status</label>
                <select class="form-select" id="statusFiltro" name="status_id">
                  <option value="" {% if not request.args.get('status_id') %}selected{% endif %}>Todos os Status</option>
                  <option value="1" {% if request.args.get('status_id')|int == 1 %}selected{% endif %}>Aberto</option>
                  <option value="2" {% if request.args.get('status_id')|int == 2 %}selected{% endif %}>Em Atendimento</option>
                  <option value="3" {% if request.args.get('status_id')|int == 3 %}selected{% endif %}>Concluído</option>
                  <option value="4" {% if request.args.get('status_id')|int == 4 %}selected{% endif %}>Recusado/Cancelado</option>
                </select>
              </div>
              
              <div class="col-md-4">
                <label for="tipoChamadoFiltro" class="form-label">Tipo de Chamado</label>
                <select class="form-select" id="tipoChamadoFiltro" name="tipo_id">
                  <option value="" {% if not request.args.get('tipo_id') %}selected{% endif %}>
                    Todos os Tipos
                  </option>
                  
                  {% for tipo in tipos %}
                    <option 
                      value="{{ tipo.tipo_id }}" 
                      {% if request.args.get('tipo_id')|int == tipo.tipo_id %}selected{% endif %}>
                      {{ tipo.nome_tipo }}
                    </option>
                  {% endfor %}
                  </select>
              </div>
              
              <div class="col-12 text-center mt-4">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-search me-2"></i> Filtrar Chamados
                </button>
                <button type="button" class="btn btn-secondary" id="btnLimparFiltros">
                  <i class="bi bi-x-circle me-2"></i> Limpar Filtros
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="card shadow-sm border-0">
          <div class="card-header bg-white border-bottom border-3" style="border-color: var(--bs-pink-primary) !important;">
            <h5 class="mb-0" style="color: var(--bs-pink-primary);">
              <i class="bi bi-list-columns-reverse me-2"></i> Chamados Registrados
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover table-sm mb-0">
                <thead class="table-header-pink">
                  <tr>
                    <th>ID</th>
                    <th>Data/Hora</th>
                    <th>Setor</th>
                    <th>Tipo de Problema</th>
                    <th>Status</th>
                    <th>Visualizar/Cancelar</th>
                  </tr>
                </thead>
                <tbody>
                  
                  {% for chamado in chamados %}
                  
                  {# LÓGICA DE COR RESOLVIDA DIRETAMENTE NO JINJA2 USANDO status_id #}
                  {% set status_id = chamado.status_id %}
                  {% set badge_color = 'info' if status_id == 1 
                              else 'warning' if status_id == 2 
                              else 'success' if status_id == 3 
                              else 'danger' if status_id == 4 
                              else 'secondary' %}
            
                  <tr>
                    <td>{{ chamado.id }}</td>
                    <td>{{ chamado.datetime.strftime('%d/%m/%Y %H:%M') }}</td>
                    
                    {# Exibe o nome do Setor #}
                    <td>{{ chamado.setor.nome_setor }}</td>
                    
                    {# Exibe o nome do Tipo de Problema #}
                    <td>{{ chamado.tipo.nome_tipo }}</td>
                    
                    <td>
                      <span class="badge text-bg-{{ badge_color }}">
                        {{ chamado.status.nome_status }}
                      </span>
                    </td>
                    
                    <td>
                                            {# Botão para ver detalhes (disponível para todos) #}
                      <a 
                                                href="{{ url_for('Chamados.detalhes_chamado', id_chamado=chamado.id) }}"
                        class="btn btn-sm btn-info me-1" 
                        title="Ver Detalhes do Chamado"
                      >
                        <i class="bi bi-eye"></i>
                      </a>
                      
                                            {# Botão para cancelar (disponível apenas para status Aberto ou Em Atendimento) #}
                      {% if status_id == 1 or status_id == 2 %}
                        <button 
                          class="btn btn-sm btn-danger" 
                          onclick="confirmarCancelamento('{{ chamado.id }}', '{{ url_for('Admin_chamados.recusar_chamado', id_chamado=chamado.id) }}')"
                          title="Cancelar Chamado (Configurações)"
                        >
                          <i class="bi bi-gear"></i> 
                        </button>
                      {% endif %}
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="6" class="text-center p-4 text-muted">
                      <i class="bi bi-info-circle me-2"></i> Nenhum chamado encontrado.
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <script>
    // ====================================================================
    // VARIÁVEIS DE URL (AJUSTADAS AO CONTEXTO DO USUÁRIO)
    // ====================================================================
    const ROTA_ATUAL_MEUS_CHAMADOS = "{{ url_for('Cliente.cliente_page') }}";

    // ====================================================================
    // FUNÇÃO DE CANCELAMENTO (SUBSTITUI A LÓGICA DO MODAL DO ADMIN)
    // ====================================================================

    async function confirmarCancelamento(chamadoId, rotaUrl) {
      Swal.fire({
        title: "Cancelar Chamado",
        text: `Deseja realmente cancelar o Chamado #${chamadoId}? Esta ação não pode ser desfeita.`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#dc3545", 
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Sim, Cancelar!",
        cancelButtonText: "Manter Chamado"
      }).then(async (result) => {
        if (result.isConfirmed) {
          const loadingAlert = Swal.fire({
            title: 'Processando...',
            text: `Cancelando chamado #${chamadoId}...`,
            icon: 'info',
            showConfirmButton: false,
            allowOutsideClick: false
          });

          try {
            const response = await fetch(rotaUrl, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
            });

            const data = await response.json();

            if (response.ok) {
              loadingAlert.close();
              Swal.fire({
                title: 'Cancelado!',
                text: data.mensagem || `Chamado #${chamadoId} foi cancelado com sucesso.`,
                icon: 'success',
                confirmButtonColor: '#198754'
              }).then(() => {
                // Recarrega a página para refletir o novo status
                window.location.reload(); 
              });
            } else {
              loadingAlert.close();
              Swal.fire({
                title: 'Erro!',
                text: data.mensagem || `Falha ao cancelar o chamado #${chamadoId}.`,
                icon: 'error',
                confirmButtonColor: '#dc3545'
              });
            }

          } catch (error) {
            loadingAlert.close();
            console.error('Erro de rede ou API:', error);
            Swal.fire({
              title: 'Erro de Conexão',
              text: 'Não foi possível se comunicar com o servidor.',
              icon: 'error',
              confirmButtonColor: '#dc3545'
            });
          }
        }
      });
    }
    
    // ====================================================================
    // LÓGICA DE FILTRO MANTIDA (APONTANDO PARA A ROTA CORRETA)
    // ====================================================================
    document.getElementById('formFiltro').addEventListener('submit', function(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      const searchParams = new URLSearchParams();

      // Itera sobre os dados do formulário e constrói a URLSearchParams
      for (const [key, value] of formData.entries()) {
        // Adiciona apenas valores que não estão vazios ('')
        if (value) {
          searchParams.append(key, value);
        }
      }

      const queryString = searchParams.toString();
      
      // Recarrega a página atual com a string de consulta (query string)
      window.location.href = ROTA_ATUAL_MEUS_CHAMADOS + (queryString ? '?' + queryString : '');
    });
    
    // Novo evento: Limpar Filtros
    document.getElementById('btnLimparFiltros').addEventListener('click', function() {
      // Recarrega a página de meus chamados sem query parameters
      window.location.href = ROTA_ATUAL_MEUS_CHAMADOS;
    });

  </script>
</body>
</html>